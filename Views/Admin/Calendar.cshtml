@model IEnumerable<Basics.Models.Trainer>

@{
    ViewData["Title"] = "Genel Takvim";
    Layout = "_Layout";
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet" />
}

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-white">Genel Takvim</h2>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addAvailabilityModal">
            <i class="bi bi-plus-lg me-2"></i>Müsaitlik Ekle
        </button>
    </div>

    <div class="card bg-dark border-secondary">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- Add Availability Modal -->
<div class="modal fade" id="addAvailabilityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title">Yeni Müsaitlik Ekle</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAvailabilityForm">
                    <div class="mb-3">
                        <label class="form-label">Eğitmen</label>
                        <select class="form-select" id="trainerSelect" required>
                            <option value="">Seçiniz...</option>
                            @foreach (var trainer in Model)
                            {
                                <option value="@trainer.TrainerID">@trainer.FullName</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Başlangıç Saati</label>
                        <input type="datetime-local" class="form-control" id="startTime" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bitiş Saati</label>
                        <input type="datetime-local" class="form-control" id="endTime" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="saveAvailability">Kaydet</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/tr.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'tr',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: '/Admin/GetCalendarEvents',
                timeZone: 'local'
            });
            calendar.render();

            document.getElementById('saveAvailability').addEventListener('click', function () {
                var trainerId = document.getElementById('trainerSelect').value;
                var startTime = document.getElementById('startTime').value;
                var endTime = document.getElementById('endTime').value;

                if (!trainerId || !startTime || !endTime) {
                    alert('Lütfen tüm alanları doldurun.');
                    return;
                }

                var data = {
                    TrainerID: parseInt(trainerId),
                    StartTime: startTime,
                    EndTime: endTime
                };

                fetch('/Admin/AddAvailability', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            var modal = bootstrap.Modal.getInstance(document.getElementById('addAvailabilityModal'));
                            modal.hide();
                            calendar.refetchEvents();
                            alert('Müsaitlik eklendi.');
                        } else {
                            alert('Hata: ' + (data.message || 'Bilinmeyen hata'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Bir hata oluştu.');
                    });
            });
        });
    </script>
}
